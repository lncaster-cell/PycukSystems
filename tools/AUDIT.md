# Аудит проекта / модуля NPC Bhvr (Ambient Life, NWN2)

Документ фиксирует текущее состояние реализации, соответствие backlog-задачам, объём кода, найденные баги и архитектурную оценку.

## 1) Объём и состав проекта

### 1.1 LOC (быстрый срез)

- `src` (NSS + MD): **1656** строк.
- `tools` (NSS + MD): **4897** строк.
- `benchmarks` (NSS + MD): **40** строк.
- `src` (только NSS): **1498** строк.
- `tools` (только NSS): **3599** строк.
- Весь репозиторий NSS (включая `third_party`): **86491** строк.

### 1.2 Наблюдение по структуре

- Практический runtime-контур сосредоточен в `src/modules/npc/`.
- `tools/` содержит проектную документацию, legacy AL-скрипты и материал для миграции.
- `third_party/` существенно увеличивает общий LOC, но не отражает объём собственного кода команды.

### 1.3 Важно: что именно учтено из `tools/`

Актуальный контекст уточнён:

- активная разработка идёт в **третьем модуле** — `src/modules/npc/` (текущий рабочий контур);
- каталоги в `tools/` (`npc_system`, `npc_behavior_system`, `al_system`) используются как база накопленных наработок/референсов;
- эти каталоги не являются приоритетным target-контуром для текущего цикла разработки и планируются к удалению, когда станут полностью не нужны.

Итог для текущего аудита:
- аудит **учитывает** `tools` как исторический/справочный слой,
- но статус «реализовано/планируется» в разделе ниже относится к активному треку в `src/modules/npc/`,
- для `tools/*` уместно вести упрощённый статус «reference/legacy», а не смешивать их с текущим execution backlog.

## 2) Соответствие задачам (что реализовано / что планируется)

Источник истины для дорожной карты: `tools/TASKS.md`.

Ограничение этого раздела: задачи A/B/C описывают активный трек `npc_*` в `src/modules/npc/`; `tools/*` рассматриваются как база прежних наработок и в этот execution backlog не входят.

### 2.1 Phase A — Runtime foundation

**Статус: выполнено (A1–A3).**

Подтверждение:
- Создан модуль `src/modules/npc/` с ключевыми файлами (`npc_core.nss`, `npc_metrics_inc.nss`, `npc_activity_inc.nss`, `README.md`).
- В `npc_core.nss` есть lifecycle area-controller (`RUNNING/PAUSED/STOPPED`) и авто-старт area-loop.
- Реализована bounded queue с приоритетами и starvation-guard.

### 2.2 Phase B — AL activity adaptation

**Статус: частично выполнено / фактически в прогрессе.**

По backlog пункты B1/B2 отмечены как не выполненные, но в коде уже есть:
- адаптерный слой activity primitives в `npc_activity_inc.nss` (нормализация slot/route, dispatch, transition stamping),
- контур keyspace `npc_*` без прямого `al_*` в core-flow.

Чего пока не видно как завершённого DoD:
- полноценный dense area-registry helper для нового контура (массовые сигналы, отдельная диагностика переполнения реестра как отдельный helper-слой).

### 2.3 Phase C — Metrics and perf gate

**Статус: частично выполнено.**

- C1 (единый metrics API): **по факту реализован** в `npc_metrics_inc.nss`, а core использует `NpcBhvrMetricInc/Add`.
- C2 (perf gate doc + fixtures): **не реализовано** в заявленном пути `docs/perf/...`.
- C3 (self-check fairness script): **не найдено** `scripts/test_npc_fairness.sh`.

## 3) Найденные баги и риски

## 3.1 Критичный логический баг: преждевременная пауза области при выходе PC

В `NpcBhvrOnAreaExit` используется условие:

- если выходит PC и `NpcBhvrCountPlayersInArea(oArea) <= 1` → `NpcBhvrAreaPause(oArea)`.

Риск:
- при двух игроках в зоне, если один выходит, в области остаётся один активный игрок, но система уже может перейти в PAUSED.
- это конфликтует с целевой моделью: активность должна продолжаться, пока **есть хотя бы один PC**.

Ожидаемая логика:
- пауза только если после выхода в области **0 игроков**.

## 3.2 Риск фоновой нагрузки в состоянии PAUSED

`NpcBhvrOnAreaTick` в конце безусловно делает `DelayCommand(1.0, ExecuteScript("npc_area_tick", oArea));`.

Следствие:
- в состоянии `PAUSED` полезная обработка не идёт, но тик продолжает перезапускаться каждую секунду.
- это нарушает принцип «нулевой/минимальной активности», особенно для неактивных зон.

Рекомендация:
- перепланировать тик только в `RUNNING`, либо добавить отдельный редкий heartbeat для PAUSED (например, с большим интервалом) — лучше первый вариант.

## 3.3 Конфликт статусов backlog vs фактическая реализация

В `tools/TASKS.md` C1 и часть B1 формально не закрыты, но соответствующие элементы уже есть в коде.

Риск:
- менеджмент/планирование не соответствует реальному техническому состоянию,
- сложнее оценивать остаток работ и риски релиза.

Рекомендация:
- синхронизировать backlog с фактическим прогрессом (либо откатить недоведённые элементы, либо формально закрыть задачи и описать gaps).

## 3.4 Риск смешения active-кода и legacy-базы (`src` vs `tools`)

Симптом:
- основной runtime-контур разрабатывается в `src/modules/npc/*`,
- при этом в `tools/*` остаётся большой объём исторических модулей и вариантов реализации.

Риск:
- случайное смешение hook-скриптов/namespace из legacy-наработок в active-контур,
- усложнение ревью и планирования из-за ложного ощущения, что все контуры равноправно «в работе»,
- задержка cleanup-фазы, если не формализовать критерии «модуль больше не нужен».

Рекомендация:
- явно пометить `tools/*` как reference/legacy в документации верхнего уровня,
- вести весь execution backlog только по `src/modules/npc`,
- заранее зафиксировать критерии удаления legacy-каталогов (`tools/*`) и сделать отдельный cleanup milestone.

## 4) Архитектурный анализ

### 4.1 Что сделано хорошо

- Чёткий **thin-entrypoint** подход: событие → один вызов core-handler.
- Изоляция доменной логики в `npc_core.nss`.
- Централизация метрик через helper API.
- Приоритетная очередь и coalescing уменьшают «дребезг» от событий perception/damage.
- Подготовлена адаптерная прослойка activity для миграции с legacy AL.

### 4.2 Слабые места текущей архитектуры

- Lifecycle неполностью согласован с производительными инвариантами из архитектурного документа:
  - `PAUSED` сейчас не означает «остановленный loop».
- Нет формализованного perf-gate и автоматизированного fairness regression-check.
- Документация задач отстаёт от кода, что повышает архитектурный долг в управлении проектом.

### 4.3 Рекомендованный порядок доработок

1. Исправить `OnAreaExit` (pause только при `0` игроков).
2. Убрать безусловный reschedule тика в `PAUSED`.
3. Внедрить perf-gate артефакты (`docs/perf/...`) и self-check script.
4. Синхронизировать `tools/TASKS.md` с фактической реализацией B/C.
5. Зафиксировать в архитектурной документации чёткое поведение состояний lifecycle и таймера.

## 5) Executive summary

- Проект в хорошем состоянии по фундаменту runtime (Phase A реально собран).
- По Phase B/C есть заметный фактический прогресс, но он не отражён в backlog-статусах.
- Обнаружены два практических риска в lifecycle-loop (преждевременная пауза и лишний тик в PAUSED), которые стоит считать приоритетом перед расширением функциональности.
