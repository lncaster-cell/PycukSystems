# Стратегия кластеризации областей и стриминга интерьеров

Документ описывает, как безопасно масштабировать город из многих outdoor/indoor областей (улицы + дома), чтобы частые входы/выходы игрока не приводили к лавинообразной активации AI и просадкам по производительности.

## 1. Проблема

Типичный риск для сценария «игрок бегает по домам»:

- При входе в интерьер область быстро активируется.
- При выходе — активируется обратно exterior-область.
- Если переключения частые, то часть областей остаётся в RUNNING дольше, чем нужно.
- NPC в невидимых интерьерах продолжают выполнять дорогостоящие ветки поведения.

Результат: рост активных area-loop, лишние heartbeat-операции, рост queue/deferred и tick budget overruns.

## 2. Целевая модель: Area Cluster + Interest Bubble

Рекомендуется двухуровневая модель:

1. **Cluster** — логическая группа областей (например, `city_a`):
   - 1–N exterior;
   - M интерьеров.
2. **Interest Bubble** — подмножество областей кластера, где есть хотя бы один игрок или игрок был недавно (grace-период).

### 2.1 Правило активности

- `RUNNING` только для областей внутри Interest Bubble.
- `PAUSED` для областей кластера вне bubble, но ещё в grace-окне.
- `STOPPED` для областей, где игроков нет и grace истёк.

Это продолжает существующий lifecycle-контракт (`RUNNING/PAUSED/STOPPED`), но добавляет кластерную оркестрацию над отдельными area-контроллерами.

## 3. Практические guardrails для частых входов/выходов

### 3.1 Debounce переходов между interior/exterior

Добавить debounce перед полным `STOP` (например, 10–20 секунд):

- игрок вышел из дома;
- интерьер не стопаем мгновенно, а переводим в `PAUSED`;
- если игрок быстро вернулся — мгновенный resume без cold-start.

### 3.2 Лимит одновременно RUNNING-интерьеров на кластер

Ввести soft/hard cap:

- soft cap (например, 3–5 интерьеров) — при превышении агрессивнее переводить «самые старые без игроков» в `PAUSED`;
- hard cap (например, 8) — новые interior-активации идут только после принудительного pause/stop кандидатов.

### 3.3 Rate limit на lifecycle churn

Ограничить число lifecycle-переходов в секунду на кластер (token bucket):

- защищает от exploit-сценария «бег по дверям»;
- снижает пиковую нагрузку на маршрутные кеши, queue rebuild и flush.

## 4. NPC в невидимых интерьерах: уровни симуляции

Нужен минимум двухуровневый simulation LOD (level of detail):

- **LOD0 (полный)** — RUNNING, есть игрок: обычный AI/pipeline.
- **LOD1 (сжатый)** — PAUSED без игроков: без pathfinding/анимационной логики; только редкий watchdog + coarse state update (раз в 30–60 секунд).
- **LOD2 (замороженный)** — STOPPED: только persist состояния, без AI до реактивации.

Ключевая идея: пока игрока нет, NPC делают только «время-протекло» апдейт, а не исполняют детальную логику маршрутов.

## 5. Что считать «дорогой работой» и отключать первой

Для interior-областей без игроков в первую очередь отключать:

1. pathfinding/перестроение маршрута;
2. perception-сканирования;
3. частые idle/emote циклы;
4. не-критичные deferred tasks.

Оставлять только:

- безопасность состояния (health/combat cleanup);
- редкий reconcile метрик;
- write-behind flush в безопасном темпе.

## 6. Оркестратор кластера: минимальный алгоритм

Каждый cluster-tick (например, 1s):

1. Собрать список игроков и их текущие области.
2. Построить Interest Bubble (текущая область + соседние по door graph, опционально).
3. Для каждой области кластера вычислить target state:
   - в bubble -> `RUNNING`;
   - вне bubble, но within grace -> `PAUSED`;
   - вне bubble и grace expired -> `STOPPED`.
4. Применить переходы с debounce + rate limit.
5. Обновить cluster-метрики (active areas, churn/sec, resume latency).

## 7. Метрики, которые покажут что решение работает

Минимальный набор:

- `cluster_running_areas` (avg/p95);
- `cluster_lifecycle_transitions_per_sec`;
- `area_resume_latency_ms` (p95);
- `npc_idle_skipped_under_pressure`;
- `queue_pending_total` и `deferred_total` по interior.

Целевой эффект:

- меньше RUNNING-областей при том же онлайне;
- меньше budget overruns при «door-spam» сценарии;
- стабильнее tick time на exterior.

## 8. План внедрения без риска

1. **Phase A (без геймплейных изменений):**
   - ввести cluster-метрики и debounce stop->pause;
   - включить только observability.
2. **Phase B:**
   - включить LOD1 для interior без игроков;
   - проверить fairness/deferred guardrails.
3. **Phase C:**
   - добавить soft/hard cap RUNNING-интерьеров и churn rate limit;
   - провести нагрузочный тест «частые вход/выход».
4. **Phase D:**
   - финальный тюнинг grace-window и watchdog interval по данным perf-report.

## 9. Короткий ответ на исходный вопрос

Да, частые входы/выходы действительно могут раздувать число активных областей и бить по производительности. Надёжное решение — не «держать всё активным», а управлять областями через cluster orchestration, interest bubble, debounce и LOD-симуляцию для NPC вне видимости игрока.
