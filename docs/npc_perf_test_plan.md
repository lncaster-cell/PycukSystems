# План performance-тестирования NPC-модуля

Документ определяет обязательный perf-план для NPC-модуля и напрямую реализует требования из раздела **«Процесс принятия решений на основе исследований»** в `docs/design.md` (пункты про план измерений, минимум 3 прогона и фиксацию результатов). См. раздел 6 в `docs/design.md`.

## 1) Матрица сценариев

Матрица покрывает 3 уровня нагрузки NPC и 2 топологии мира:
- **single-area** — вся нагрузка в одной области;
- **multi-area** — равномерное распределение по 4 областям (если не оговорено иное).

| Scenario ID | NPC load | Topology | Раскладка NPC | Цель сценария |
|---|---:|---|---|---|
| S1 | 10× | single-area | 10 NPC в 1 area | Базовый sanity/baseline |
| S2 | 10× | multi-area | 3/3/2/2 по 4 area | Проверка межобластных накладных расходов |
| S3 | 50× | single-area | 50 NPC в 1 area | Проверка локального tick pressure |
| S4 | 50× | multi-area | 13/13/12/12 по 4 area | Масштабирование area-tick контроллеров |
| S5 | 100× | single-area | 100 NPC в 1 area | Стресс single hot-spot |
| S6 | 100× | multi-area | 25/25/25/25 по 4 area | Стресс распределённой нагрузки |

---

## 2) Измеряемые метрики

Для каждого сценария обязательно собирать:
- `p50_tick_ms`
- `p95_tick_ms`
- `p99_tick_ms`
- `queue_depth_max`
- `flush_ms_p95`
- `sqlite_busy_count`
- `event_latency_ms_p95`

### Определения
- **tick percentiles** — перцентили времени выполнения игрового тика в ms.
- **queue depth** — максимальная длина внутренней очереди задач/событий за прогон.
- **flush_ms** — время сброса батчей (persist/flush), p95 в ms.
- **SQLITE_BUSY count** — число конфликтов блокировок SQLite за прогон.
- **event latency** — задержка от публикации события до завершения handler, p95 в ms.

---

## 3) Пороговые значения pass/fail

Сценарий считается **PASS**, только если все метрики в строке укладываются в пороги.

| Scenario ID | p50 tick (ms) | p95 tick (ms) | p99 tick (ms) | queue depth max | flush_ms p95 | SQLITE_BUSY count | event latency p95 (ms) |
|---|---:|---:|---:|---:|---:|---:|---:|
| S1 (10× single) | ≤ 8 | ≤ 14 | ≤ 18 | ≤ 50 | ≤ 10 | = 0 | ≤ 20 |
| S2 (10× multi)  | ≤ 9 | ≤ 15 | ≤ 20 | ≤ 60 | ≤ 11 | ≤ 1 | ≤ 22 |
| S3 (50× single) | ≤ 12 | ≤ 20 | ≤ 28 | ≤ 140 | ≤ 16 | ≤ 2 | ≤ 35 |
| S4 (50× multi)  | ≤ 13 | ≤ 22 | ≤ 30 | ≤ 160 | ≤ 18 | ≤ 3 | ≤ 38 |
| S5 (100× single)| ≤ 16 | ≤ 28 | ≤ 40 | ≤ 300 | ≤ 24 | ≤ 5 | ≤ 55 |
| S6 (100× multi) | ≤ 18 | ≤ 30 | ≤ 42 | ≤ 340 | ≤ 26 | ≤ 6 | ≤ 60 |

### Правила интерпретации
1. **Hard-fail метрики:** `p99_tick_ms`, `sqlite_busy_count`, `event_latency_ms_p95`.
2. Любое превышение hard-fail метрики в любом прогоне = **FAIL** сценария.
3. Для остальных метрик допускается только соответствие порогам в агрегированной статистике (см. раздел отчёта).

---

## 4) Порядок запуска и длительность

Минимум **3 прогона на сценарий**. Рекомендуется 5 для спорных случаев.

### Порядок выполнения
1. Warm-up окружения: 5 минут (без записи в отчёт).
2. Тестовые сценарии идут в порядке: **S1 → S2 → S3 → S4 → S5 → S6**.
3. Для каждого сценария:
   - Run A: 15 минут;
   - Cooldown: 3 минуты;
   - Run B: 15 минут;
   - Cooldown: 3 минуты;
   - Run C: 15 минут.
4. Если один из прогонов содержит технический сбой (не связанный с производительностью), прогон перезапускается и помечается как `rerun`.

### Минимальный объём данных
- 6 сценариев × 3 прогона × 15 минут = **270 минут чистых измерений**.
- Итоговый verdict по perf-gate делается только после полного набора.

---

## 5) Формат отчёта для perf-gate

Отчёт сохраняется в `docs/perf_reports/<date>_npc_perf_gate.md` и включает:

1. **Контекст теста**
   - commit SHA
   - ветка
   - конфигурация сервера/БД
   - дата/время
2. **Таблица результатов (агрегат по 3+ прогонам)**
3. **Список отклонений** (если есть)
4. **Финальный вывод:** `merge allowed` или `merge blocked`

### Шаблон таблицы результатов

| Scenario ID | Runs | p50 tick | p95 tick | p99 tick | queue depth max | flush_ms p95 | SQLITE_BUSY count | event latency p95 | Verdict |
|---|---:|---:|---:|---:|---:|---:|---:|---:|---|
| S1 | 3 | ... | ... | ... | ... | ... | ... | ... | PASS/FAIL |
| S2 | 3 | ... | ... | ... | ... | ... | ... | ... | PASS/FAIL |
| S3 | 3 | ... | ... | ... | ... | ... | ... | ... | PASS/FAIL |
| S4 | 3 | ... | ... | ... | ... | ... | ... | ... | PASS/FAIL |
| S5 | 3 | ... | ... | ... | ... | ... | ... | ... | PASS/FAIL |
| S6 | 3 | ... | ... | ... | ... | ... | ... | ... | PASS/FAIL |

### Правило итогового решения perf-gate
- **merge allowed**: все сценарии S1–S6 имеют `PASS`.
- **merge blocked**: хотя бы один сценарий имеет `FAIL`.

---

## 6) Трассировка к `docs/design.md`

Данный план является прикладной реализацией раздела 6 (`Процесс принятия решений на основе исследований`) в `docs/design.md`:
- фиксирует **план измерения** (сценарии, длительность, метрики);
- требует **минимум 3 прогона**;
- задаёт формализованное **решение по данным** через perf-gate verdict;
- предполагает **фиксацию результата** в `docs/perf_reports/`.
