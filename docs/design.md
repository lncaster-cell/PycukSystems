# Дизайн-документ: NWN2 Systems Platform

## 1. Цель
Создать производительную, масштабируемую и поэтапно развиваемую модульную систему скриптов для персонального сервера NWN2, поддерживающую большое количество игровых механик.

## 2. Архитектурная концепция
**Гибрид:**
1. **Event-driven ядро** для реактивной обработки событий движка.
2. **Локальные area-tick контроллеры** для управления периодическими задачами в пределах областей (area).
3. **SQLite через NWNX** как персистентный слой состояния и метрик.
4. **Глобальный менеджер** только для межобластной координации и агрегированных метрик.

Это снижает центральную contention-точку и распределяет нагрузку по area-boundary.

## 3. Ключевые требования

### 3.1 Функциональные
- Поддержка множества независимых игровых механик в виде модулей.
- Единый lifecycle модулей (init/start/stop/reload).
- Наблюдаемость: сбор runtime-метрик и событий деградации.

### 3.2 Нефункциональные
- Приоритет производительности перед архитектурной «красотой».
- Предсказуемая деградация под нагрузкой (graceful degradation).
- Минимизация глобальных синхронных операций в игровом тике.

## 4. Runtime-модель

### 4.1 Event-driven ядро
Ядро обрабатывает входящие игровые события и маршрутизирует их в модульные handlers с фиксированным контрактом.

### 4.2 Area-tick контроллеры
Для каждой области создаётся локальный контроллер:
- **Бакетирование:** распределение NPC/задач по N корзинам;
- **Jitter:** псевдослучайный сдвиг периода обработки во избежание «шипов»;
- **Step-based handlers:** выполнение тяжёлой логики порциями в несколько шагов/тиков.

### 4.3 Глобальный менеджер
Используется только для:
- кросс-area задач (например, глобальные сезонные эффекты);
- агрегации метрик и health-сигналов.

## 5. Персистентность (NWNX + SQLite)
- SQLite хранит долговременное состояние модулей и статистику.
- Пишем пакетно/асинхронно относительно логики тика там, где это допустимо игровыми ограничениями.
- Доступ к БД оборачивается в thin repository слой, чтобы не «протекал» SQL в игровую логику.

## 6. Процесс принятия решений на основе исследований
Перед любым значимым архитектурным решением обязателен performance-review:
1. Гипотеза и минимум два альтернативных подхода.
2. План измерения (сценарий, длительность, метрики).
3. Замеры (минимум 3 прогона).
4. Решение по итогам данных (а не интуиции).
5. Фиксация результата в `docs/` + ссылка на benchmark-данные.

## 7. Первая итерация: модуль поведения NPC

### 7.1 Scope
Модуль должен регулировать поведение NPC и включать:
- idle-поведение и патрулирование;
- реакцию на триггеры/персепшен;
- управление агрессией и возвратом к базовым состояниям;
- ограничение частоты тяжёлых вычислений через area-tick контроллеры.

### 7.2 Производительные паттерны
- Отказ от «полного пересчёта всех NPC каждый тик».
- Выделение «горячих» и «холодных» веток логики.
- Дедупликация событий и антидребезг состояний.
- Лимит на объём обработки за тик (tick budget cap).

### 7.3 Метрики успеха
- Стабильный tick time под целевой NPC-нагрузкой.
- Отсутствие периодических latency-spike при пиковых событиях.
- Воспроизводимость поведения NPC при reload модуля.

### 7.4 SLO, perf-gate и rollback для первой фазы NPC

#### SLO (Phase 1)
- **p95 area-tick latency:** не более **12 ms** на area при штатной целевой нагрузке.
- **Queue depth (event/tick queue):** p95 не более **200**, p99 не более **300** элементов.
- **Dropped/Deferred events:** суммарно не более **0.5%** от всех входящих событий за 10-минутное окно.
- **Tick budget overruns:** не более **1%** тиков с превышением budget cap.

#### Perf-gate для merge
- Любое изменение блокируется к merge, если в benchmark-сценарии первой фазы фиксируется деградация любой ключевой метрики выше порога:
  - p95 area-tick latency: ухудшение более **+5%**;
  - p99 queue depth: ухудшение более **+10%**;
  - dropped/deferred events: рост более **+0.2 п.п.**;
  - DB flush duration p95: ухудшение более **+10%**.
- Сравнение выполняется относительно актуального baseline (не старше 14 дней) по минимум 3 прогонам.

#### Rollback-процедура
1. **Сразу снизить нагрузку на runtime-фичи NPC**:
   - отключить/ослабить тяжёлые AI-step ветки;
   - уменьшить лимит задач на тик;
   - увеличить интервал обработки «холодных» состояний.
2. **Откатить tuning-константы контроллера** к последним стабильным значениям:
   - bucket count;
   - jitter window;
   - tick budget cap;
   - queue soft/hard limit.
3. **Отключить новые event-hooks**, добавленные в релизе, если после п.1–2 деградация сохраняется.
4. **Диагностика в фиксированном порядке**:
   - проверить tick orchestration latency по area;
   - проверить queue growth / deferred-rate;
   - проверить DB flush p95/p99 и размер batch;
   - проверить AI step cost (hot path) по типам NPC.
5. **Если SLO не восстановлены** — выполнить частичный rollback модуля NPC до предыдущей стабильной версии и повторить валидацию baseline.

#### Минимальный runtime-набор метрик
- **Tick orchestration:** p50/p95/p99 area-tick time, budget overrun rate, queue depth.
- **DB flush:** batch size, flush duration p50/p95/p99, flush error rate.
- **AI step cost:** средняя и p95 длительность шага, top-N самых дорогих handlers, deferred-rate по шагам.

#### Checklist: Перед merge
- [ ] Бенчмарк первой фазы пройден (≥ 3 прогона), отчёт приложен.
- [ ] Perf-gate пороги не нарушены относительно baseline.
- [ ] Проверены SLO по p95 area-tick, queue depth и dropped/deferred events.
- [ ] Зафиксирован rollback-план для изменённых флагов/констант.
- [ ] Обновлены runtime-дашборды для tick orchestration, DB flush и AI step cost.

## 8. План этапов
1. Каркас ядра событий и контракт модулей.
2. Реализация area-tick контроллера с бакетами/jitter.
3. Интеграция NWNX SQLite и базовая схема хранения.
4. MVP модуля поведения NPC.
5. Бенчмарки и оптимизация горячих путей.

## 9. Критерии готовности первой фазы
- [x] Зафиксирована целевая архитектурная концепция.
- [x] Определён performance-first процесс принятия решений.
- [x] Описан scope первой целевой механики (NPC behavior).
- [ ] Подготовлены baseline benchmark-сценарии.
- [ ] Реализован и подключен MVP модуля NPC behavior.
