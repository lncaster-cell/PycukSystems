name: NWN Script Compiler

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - dev
  workflow_dispatch:
    inputs:
      mode:
        description: "Compilation mode"
        required: true
        type: choice
        options:
          - check
          - build
          - optimize
          - bugscan
        default: check

jobs:
  compile-pr:
    if: ${{ github.event_name == 'pull_request' || github.event_name == 'push' }}
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        mode: [check, bugscan, build, optimize]
    name: compile (${{ matrix.mode }})

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cleanup workspace
        shell: pwsh
        run: |
          Remove-Item -Path 'dist', 'output', '.ci' -Recurse -Force -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Path 'dist/ncs' -Force | Out-Null

      - name: Verify runner OS and compiler binary
        shell: pwsh
        run: |
          if ($env:RUNNER_OS -ne 'Windows') {
            throw "This workflow requires windows-latest. Current RUNNER_OS: $env:RUNNER_OS"
          }

          if (-not (Test-Path -Path 'third_party/toolchain/NWNScriptCompiler.exe' -PathType Leaf)) {
            throw "NWNScriptCompiler.exe not found at third_party/toolchain/NWNScriptCompiler.exe."
          }

      - name: Prepare stock includes for CI
        shell: pwsh
        run: |
          $sourceStock = Join-Path $PWD 'third_party/nwn2_stock_scripts'
          $ciStock = Join-Path $PWD '.ci/nwn2_stock_scripts'

          if (Test-Path -Path $ciStock) {
            Remove-Item -Path $ciStock -Recurse -Force
          }

          New-Item -ItemType Directory -Path $ciStock -Force | Out-Null
          Copy-Item -Path (Join-Path $sourceStock '*') -Destination $ciStock -Recurse -Force

          $upperNwscript = Join-Path $ciStock 'nwscript.NSS'
          $lowerNwscript = Join-Path $ciStock 'nwscript.nss'

          if (-not (Test-Path -Path $upperNwscript -PathType Leaf)) {
            throw "Missing stock include file: $upperNwscript"
          }

          if (-not (Test-Path -Path $lowerNwscript -PathType Leaf)) {
            Copy-Item -Path $upperNwscript -Destination $lowerNwscript -Force
          }

          $fileCount = (Get-ChildItem -Path $ciStock -Recurse -File | Measure-Object).Count
          Write-Host "Prepared stock includes in $ciStock"
          Write-Host "Stock include file count: $fileCount"

      - name: Compile scripts (${{ matrix.mode }})
        shell: pwsh
        run: |
          $mode = '${{ matrix.mode }}'
          $compiler = Join-Path $PWD 'third_party/toolchain/NWNScriptCompiler.exe'
          $stockIncludePath = Join-Path $PWD '.ci/nwn2_stock_scripts'
          $sourceRootIncludePath = Join-Path $PWD 'src'
                    $npcIncludePath = Join-Path $PWD 'src/modules/npc'
          $projectIncludePath = Join-Path $PWD 'scripts'
          $nwnxIncludePath = Join-Path $PWD 'third_party/nwnx_includes'
          $moduleIncludeDirs = Get-ChildItem -Path (Join-Path $PWD 'src/modules') -Recurse -File -Filter '*.nss' |
            Select-Object -ExpandProperty DirectoryName -Unique |
            Sort-Object

          $includeArgs = @('-i', $stockIncludePath, '-i', $sourceRootIncludePath, '-i', $npcIncludePath, '-i', $projectIncludePath, '-i', $nwnxIncludePath)
          foreach ($moduleIncludeDir in $moduleIncludeDirs) {
            $includeArgs += @('-i', $moduleIncludeDir)
          }

          $logDir = Join-Path $PWD 'ci-logs'
          New-Item -ItemType Directory -Path $logDir -Force | Out-Null
          $logPath = Join-Path $logDir "$mode.log"
          if (Test-Path $logPath) { Remove-Item $logPath -Force }

          $distDir = Join-Path $PWD 'dist/ncs'
          if (Test-Path -Path $distDir) {
            Remove-Item -Path $distDir -Recurse -Force
          }
          New-Item -ItemType Directory -Path $distDir -Force | Out-Null

          $files = @(
            Get-ChildItem -Path 'src' -Recurse -File -Filter '*.nss'
          ) | Sort-Object FullName
          if ($files.Count -eq 0) {
            "No .nss files found under src/." | Tee-Object -FilePath $logPath -Append
            "MODE=$mode" | Tee-Object -FilePath $logPath -Append
            "SCRIPTS=0" | Tee-Object -FilePath $logPath -Append
            "WARNINGS=0" | Tee-Object -FilePath $logPath -Append
            "ERRORS=0" | Tee-Object -FilePath $logPath -Append
            exit 0
          }

          $warningCount = 0
          $errorCount = 0
          $hasNonZeroExit = $false

          foreach ($file in $files) {
            "=== FILE: $($file.FullName) ===" | Tee-Object -FilePath $logPath -Append

            $commandArgs = @()
            switch ($mode) {
              'check' { $commandArgs = @('-y') + $includeArgs + @($file.FullName) }
              'bugscan' { $commandArgs = @('-a', '-y') + $includeArgs + @($file.FullName) }
              'build' { $commandArgs = @('-y', '-e') + $includeArgs + @($file.FullName) }
              'optimize' { $commandArgs = @('-a', '-y', '-e') + $includeArgs + @($file.FullName) }
              default { throw "Unsupported mode: $mode" }
            }

            $output = & $compiler @commandArgs 2>&1
            $exitCode = $LASTEXITCODE

            foreach ($line in $output) {
              $text = [string]$line
              $text | Tee-Object -FilePath $logPath -Append
              if ($text -match ':\s+Warning\b') { $warningCount++ }
              if ($text -match ':\s+Error\b') { $errorCount++ }
            }

            if ($exitCode -ne 0) {
              "Compiler exited with non-zero code $exitCode for $($file.FullName)" | Tee-Object -FilePath $logPath -Append
              $hasNonZeroExit = $true
            }
          }

          "" | Tee-Object -FilePath $logPath -Append
          "MODE=$mode" | Tee-Object -FilePath $logPath -Append
          "SCRIPTS=$($files.Count)" | Tee-Object -FilePath $logPath -Append
          "WARNINGS=$warningCount" | Tee-Object -FilePath $logPath -Append
          "ERRORS=$errorCount" | Tee-Object -FilePath $logPath -Append

          if ($errorCount -gt 0 -or $hasNonZeroExit) {
            throw "Compilation finished with ERRORS=$errorCount"
          }

      - name: Collect compiled scripts (${{ matrix.mode }})
        if: always()
        id: collect_ncs
        shell: pwsh
        run: |
          $mode = '${{ matrix.mode }}'
          $distDir = Join-Path $PWD 'dist/ncs'

          if (Test-Path -Path $distDir) {
            Remove-Item -Path $distDir -Recurse -Force
          }
          New-Item -ItemType Directory -Path $distDir -Force | Out-Null

          $sourceScriptsRoot = Join-Path $PWD 'src'
          $compiledFiles = Get-ChildItem -Path $sourceScriptsRoot -Recurse -File -Filter '*.ncs' -ErrorAction SilentlyContinue

          foreach ($compiledFile in $compiledFiles) {
            $destinationPath = Join-Path $distDir $compiledFile.Name
            Copy-Item -Path $compiledFile.FullName -Destination $destinationPath -Force
            Write-Host "Collected $($compiledFile.FullName) -> $destinationPath"
          }

          $ncsCount = (Get-ChildItem -Path $distDir -File -Filter '*.ncs' -ErrorAction SilentlyContinue | Measure-Object).Count
          "ncs_count=$ncsCount" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

          if ($mode -in @('build', 'optimize') -and $ncsCount -eq 0) {
            throw "Mode $mode requires compiled .ncs files, but none were collected into dist/ncs"
          }

      - name: Upload logs (${{ matrix.mode }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ matrix.mode }}
          path: ci-logs/${{ matrix.mode }}.log

      - name: Write CI Summary (${{ matrix.mode }})
        if: always()
        shell: pwsh
        run: |
          $mode = '${{ matrix.mode }}'
          $logPath = Join-Path $PWD "ci-logs/$mode.log"
          $reportDir = Join-Path $PWD 'reports'
          New-Item -ItemType Directory -Path $reportDir -Force | Out-Null
          $reportPath = Join-Path $reportDir "$mode.txt"

          if (-not (Test-Path -Path $logPath -PathType Leaf)) {
            @(
              "MODE=$mode"
              "SCRIPTS=0, WARNINGS=0, ERRORS=0"
              'FIRST_ERRORS:'
              '(log file not found)'
              ''
              'FIRST_WARNINGS:'
              '(log file not found)'
              ''
              "FULL_LOG_ARTIFACT=logs-$mode"
            ) | Set-Content -Path $reportPath

            Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "### CI Summary ($mode)"
            Get-Content -Path $reportPath | Add-Content -Path $env:GITHUB_STEP_SUMMARY
            exit 0
          }

          $lines = Get-Content -Path $logPath
          $scriptLine = $lines | Where-Object { $_ -match '^SCRIPTS=' } | Select-Object -Last 1
          $warningLine = $lines | Where-Object { $_ -match '^WARNINGS=' } | Select-Object -Last 1
          $errorLine = $lines | Where-Object { $_ -match '^ERRORS=' } | Select-Object -Last 1

          $scripts = if ($scriptLine) { ($scriptLine -replace '^SCRIPTS=', '') } else { '0' }
          $warnings = if ($warningLine) { ($warningLine -replace '^WARNINGS=', '') } else { '0' }
          $errors = if ($errorLine) { ($errorLine -replace '^ERRORS=', '') } else { '0' }

          $errorMatches = $lines | Where-Object { $_ -match '(:\s+Error\b|Error:\s*NSC)' }
          $warningMatches = $lines | Where-Object { $_ -match '(:\s+Warning\b|Warning:\s*NSC)' }
          $firstErrors = @($errorMatches | Select-Object -Unique | Select-Object -First 20)
          $firstWarnings = @($warningMatches | Select-Object -Unique | Select-Object -First 20)

          $summaryLines = @(
            "MODE=$mode"
            "SCRIPTS=$scripts, WARNINGS=$warnings, ERRORS=$errors"
            'FIRST_ERRORS:'
          )

          if ($firstErrors.Count -gt 0) {
            $summaryLines += $firstErrors
          } else {
            $summaryLines += '(none)'
          }

          $summaryLines += ''
          $summaryLines += 'FIRST_WARNINGS:'

          if ($firstWarnings.Count -gt 0) {
            $summaryLines += $firstWarnings
          } else {
            $summaryLines += '(none)'
          }

          $summaryLines += ''
          $summaryLines += "FULL_LOG_ARTIFACT=logs-$mode"

          $summaryLines | Set-Content -Path $reportPath

          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "### CI Summary ($mode)"
          Get-Content -Path $reportPath | Add-Content -Path $env:GITHUB_STEP_SUMMARY

      - name: Upload reports (${{ matrix.mode }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reports-${{ matrix.mode }}
          path: reports/${{ matrix.mode }}.txt
          if-no-files-found: warn

      - name: Upload ready scripts (${{ matrix.mode }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ready-ncs-${{ matrix.mode }}
          path: dist/ncs/*.ncs
          if-no-files-found: warn
          retention-days: 3

  compile-manual:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    runs-on: windows-latest
    name: compile (manual ${{ github.event.inputs.mode }})

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cleanup workspace
        shell: pwsh
        run: |
          Remove-Item -Path 'dist', 'output', '.ci' -Recurse -Force -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Path 'dist/ncs' -Force | Out-Null

      - name: Verify runner OS and compiler binary
        shell: pwsh
        run: |
          if ($env:RUNNER_OS -ne 'Windows') {
            throw "This workflow requires windows-latest. Current RUNNER_OS: $env:RUNNER_OS"
          }

          if (-not (Test-Path -Path 'third_party/toolchain/NWNScriptCompiler.exe' -PathType Leaf)) {
            throw "NWNScriptCompiler.exe not found at third_party/toolchain/NWNScriptCompiler.exe."
          }

      - name: Prepare stock includes for CI
        shell: pwsh
        run: |
          $sourceStock = Join-Path $PWD 'third_party/nwn2_stock_scripts'
          $ciStock = Join-Path $PWD '.ci/nwn2_stock_scripts'

          if (Test-Path -Path $ciStock) {
            Remove-Item -Path $ciStock -Recurse -Force
          }

          New-Item -ItemType Directory -Path $ciStock -Force | Out-Null
          Copy-Item -Path (Join-Path $sourceStock '*') -Destination $ciStock -Recurse -Force

          $upperNwscript = Join-Path $ciStock 'nwscript.NSS'
          $lowerNwscript = Join-Path $ciStock 'nwscript.nss'

          if (-not (Test-Path -Path $upperNwscript -PathType Leaf)) {
            throw "Missing stock include file: $upperNwscript"
          }

          if (-not (Test-Path -Path $lowerNwscript -PathType Leaf)) {
            Copy-Item -Path $upperNwscript -Destination $lowerNwscript -Force
          }

      - name: Compile scripts (${{ github.event.inputs.mode }})
        shell: pwsh
        run: |
          $mode = '${{ github.event.inputs.mode }}'
          $compiler = Join-Path $PWD 'third_party/toolchain/NWNScriptCompiler.exe'
          $stockIncludePath = Join-Path $PWD '.ci/nwn2_stock_scripts'
          $sourceRootIncludePath = Join-Path $PWD 'src'
                    $npcIncludePath = Join-Path $PWD 'src/modules/npc'
          $projectIncludePath = Join-Path $PWD 'scripts'
          $nwnxIncludePath = Join-Path $PWD 'third_party/nwnx_includes'
          $moduleIncludeDirs = Get-ChildItem -Path (Join-Path $PWD 'src/modules') -Recurse -File -Filter '*.nss' |
            Select-Object -ExpandProperty DirectoryName -Unique |
            Sort-Object

          $includeArgs = @('-i', $stockIncludePath, '-i', $sourceRootIncludePath, '-i', $npcIncludePath, '-i', $projectIncludePath, '-i', $nwnxIncludePath)
          foreach ($moduleIncludeDir in $moduleIncludeDirs) {
            $includeArgs += @('-i', $moduleIncludeDir)
          }

          $logDir = Join-Path $PWD 'ci-logs'
          New-Item -ItemType Directory -Path $logDir -Force | Out-Null
          $logPath = Join-Path $logDir "$mode.log"
          if (Test-Path $logPath) { Remove-Item $logPath -Force }

          $distDir = Join-Path $PWD 'dist/ncs'
          if (Test-Path -Path $distDir) {
            Remove-Item -Path $distDir -Recurse -Force
          }
          New-Item -ItemType Directory -Path $distDir -Force | Out-Null

          $files = @(
            Get-ChildItem -Path 'src' -Recurse -File -Filter '*.nss'
          ) | Sort-Object FullName
          if ($files.Count -eq 0) {
            "No .nss files found under src/." | Tee-Object -FilePath $logPath -Append
            "MODE=$mode" | Tee-Object -FilePath $logPath -Append
            "SCRIPTS=0" | Tee-Object -FilePath $logPath -Append
            "WARNINGS=0" | Tee-Object -FilePath $logPath -Append
            "ERRORS=0" | Tee-Object -FilePath $logPath -Append
            exit 0
          }

          $warningCount = 0
          $errorCount = 0
          $hasNonZeroExit = $false

          foreach ($file in $files) {
            "=== FILE: $($file.FullName) ===" | Tee-Object -FilePath $logPath -Append

            $commandArgs = @()
            switch ($mode) {
              'check' { $commandArgs = @('-y') + $includeArgs + @($file.FullName) }
              'bugscan' { $commandArgs = @('-a', '-y') + $includeArgs + @($file.FullName) }
              'build' { $commandArgs = @('-y', '-e') + $includeArgs + @($file.FullName) }
              'optimize' { $commandArgs = @('-a', '-y', '-e') + $includeArgs + @($file.FullName) }
              default { throw "Unsupported mode: $mode" }
            }

            $output = & $compiler @commandArgs 2>&1
            $exitCode = $LASTEXITCODE

            foreach ($line in $output) {
              $text = [string]$line
              $text | Tee-Object -FilePath $logPath -Append
              if ($text -match ':\s+Warning\b') { $warningCount++ }
              if ($text -match ':\s+Error\b') { $errorCount++ }
            }

            if ($exitCode -ne 0) {
              "Compiler exited with non-zero code $exitCode for $($file.FullName)" | Tee-Object -FilePath $logPath -Append
              $hasNonZeroExit = $true
            }
          }

          "" | Tee-Object -FilePath $logPath -Append
          "MODE=$mode" | Tee-Object -FilePath $logPath -Append
          "SCRIPTS=$($files.Count)" | Tee-Object -FilePath $logPath -Append
          "WARNINGS=$warningCount" | Tee-Object -FilePath $logPath -Append
          "ERRORS=$errorCount" | Tee-Object -FilePath $logPath -Append

          if ($errorCount -gt 0 -or $hasNonZeroExit) {
            throw "Compilation finished with ERRORS=$errorCount"
          }

      - name: Collect compiled scripts (${{ github.event.inputs.mode }})
        if: always()
        id: collect_ncs_manual
        shell: pwsh
        run: |
          $mode = '${{ github.event.inputs.mode }}'
          $distDir = Join-Path $PWD 'dist/ncs'

          if (Test-Path -Path $distDir) {
            Remove-Item -Path $distDir -Recurse -Force
          }
          New-Item -ItemType Directory -Path $distDir -Force | Out-Null

          $sourceScriptsRoot = Join-Path $PWD 'src'
          $compiledFiles = Get-ChildItem -Path $sourceScriptsRoot -Recurse -File -Filter '*.ncs' -ErrorAction SilentlyContinue

          foreach ($compiledFile in $compiledFiles) {
            $destinationPath = Join-Path $distDir $compiledFile.Name
            Copy-Item -Path $compiledFile.FullName -Destination $destinationPath -Force
            Write-Host "Collected $($compiledFile.FullName) -> $destinationPath"
          }

          $ncsCount = (Get-ChildItem -Path $distDir -File -Filter '*.ncs' -ErrorAction SilentlyContinue | Measure-Object).Count
          "ncs_count=$ncsCount" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

          if ($mode -in @('build', 'optimize') -and $ncsCount -eq 0) {
            throw "Mode $mode requires compiled .ncs files, but none were collected into dist/ncs"
          }

      - name: Upload logs (${{ github.event.inputs.mode }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ github.event.inputs.mode }}
          path: ci-logs/${{ github.event.inputs.mode }}.log

      - name: Write CI Summary (${{ github.event.inputs.mode }})
        if: always()
        shell: pwsh
        run: |
          $mode = '${{ github.event.inputs.mode }}'
          $logPath = Join-Path $PWD "ci-logs/$mode.log"
          $reportDir = Join-Path $PWD 'reports'
          New-Item -ItemType Directory -Path $reportDir -Force | Out-Null
          $reportPath = Join-Path $reportDir "$mode.txt"

          if (-not (Test-Path -Path $logPath -PathType Leaf)) {
            @(
              "MODE=$mode"
              "SCRIPTS=0, WARNINGS=0, ERRORS=0"
              'FIRST_ERRORS:'
              '(log file not found)'
              ''
              'FIRST_WARNINGS:'
              '(log file not found)'
              ''
              "FULL_LOG_ARTIFACT=logs-$mode"
            ) | Set-Content -Path $reportPath

            Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "### CI Summary ($mode)"
            Get-Content -Path $reportPath | Add-Content -Path $env:GITHUB_STEP_SUMMARY
            exit 0
          }

          $lines = Get-Content -Path $logPath
          $scriptLine = $lines | Where-Object { $_ -match '^SCRIPTS=' } | Select-Object -Last 1
          $warningLine = $lines | Where-Object { $_ -match '^WARNINGS=' } | Select-Object -Last 1
          $errorLine = $lines | Where-Object { $_ -match '^ERRORS=' } | Select-Object -Last 1

          $scripts = if ($scriptLine) { ($scriptLine -replace '^SCRIPTS=', '') } else { '0' }
          $warnings = if ($warningLine) { ($warningLine -replace '^WARNINGS=', '') } else { '0' }
          $errors = if ($errorLine) { ($errorLine -replace '^ERRORS=', '') } else { '0' }

          $errorMatches = $lines | Where-Object { $_ -match '(:\s+Error\b|Error:\s*NSC)' }
          $warningMatches = $lines | Where-Object { $_ -match '(:\s+Warning\b|Warning:\s*NSC)' }
          $firstErrors = @($errorMatches | Select-Object -Unique | Select-Object -First 20)
          $firstWarnings = @($warningMatches | Select-Object -Unique | Select-Object -First 20)

          $summaryLines = @(
            "MODE=$mode"
            "SCRIPTS=$scripts, WARNINGS=$warnings, ERRORS=$errors"
            'FIRST_ERRORS:'
          )

          if ($firstErrors.Count -gt 0) {
            $summaryLines += $firstErrors
          } else {
            $summaryLines += '(none)'
          }

          $summaryLines += ''
          $summaryLines += 'FIRST_WARNINGS:'

          if ($firstWarnings.Count -gt 0) {
            $summaryLines += $firstWarnings
          } else {
            $summaryLines += '(none)'
          }

          $summaryLines += ''
          $summaryLines += "FULL_LOG_ARTIFACT=logs-$mode"

          $summaryLines | Set-Content -Path $reportPath

          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "### CI Summary ($mode)"
          Get-Content -Path $reportPath | Add-Content -Path $env:GITHUB_STEP_SUMMARY

      - name: Upload reports (${{ github.event.inputs.mode }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reports-${{ github.event.inputs.mode }}
          path: reports/${{ github.event.inputs.mode }}.txt
          if-no-files-found: warn

      - name: Upload ready scripts (${{ github.event.inputs.mode }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ready-ncs-${{ github.event.inputs.mode }}
          path: dist/ncs/*.ncs
          if-no-files-found: warn
          retention-days: 3
