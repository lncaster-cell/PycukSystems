name: NWN Script Compiler

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - dev
  workflow_dispatch:
    inputs:
      mode:
        description: "Compilation mode"
        required: true
        type: choice
        options:
          - check
          - build
          - optimize
          - bugscan
        default: check

jobs:
  compile-pr:
    if: ${{ github.event_name == 'pull_request' || github.event_name == 'push' }}
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        mode: [check, bugscan, optimize]
    name: compile (${{ matrix.mode }})

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify runner OS and compiler binary
        shell: pwsh
        run: |
          if ($env:RUNNER_OS -ne 'Windows') {
            throw "This workflow requires windows-latest. Current RUNNER_OS: $env:RUNNER_OS"
          }

          if (-not (Test-Path -Path 'tools/NWNScriptCompiler.exe' -PathType Leaf)) {
            throw "NWNScriptCompiler.exe not found at tools/NWNScriptCompiler.exe."
          }

      - name: Prepare stock includes for CI
        shell: pwsh
        run: |
          $sourceStock = Join-Path $PWD 'third_party/nwn2_stock_scripts'
          $ciStock = Join-Path $PWD '.ci/nwn2_stock_scripts'

          if (Test-Path -Path $ciStock) {
            Remove-Item -Path $ciStock -Recurse -Force
          }

          New-Item -ItemType Directory -Path $ciStock -Force | Out-Null
          Copy-Item -Path (Join-Path $sourceStock '*') -Destination $ciStock -Recurse -Force

          $upperNwscript = Join-Path $ciStock 'nwscript.NSS'
          $lowerNwscript = Join-Path $ciStock 'nwscript.nss'

          if (-not (Test-Path -Path $upperNwscript -PathType Leaf)) {
            throw "Missing stock include file: $upperNwscript"
          }

          if (-not (Test-Path -Path $lowerNwscript -PathType Leaf)) {
            Copy-Item -Path $upperNwscript -Destination $lowerNwscript -Force
          }

          $fileCount = (Get-ChildItem -Path $ciStock -Recurse -File | Measure-Object).Count
          Write-Host "Prepared stock includes in $ciStock"
          Write-Host "Stock include file count: $fileCount"

      - name: Compile scripts (${{ matrix.mode }})
        shell: pwsh
        run: |
          $mode = '${{ matrix.mode }}'
          $compiler = Join-Path $PWD 'tools/NWNScriptCompiler.exe'
          $stockIncludePath = Join-Path $PWD '.ci/nwn2_stock_scripts'
          $sourceRootIncludePath = Join-Path $PWD 'src'
          $npcBehaviorIncludePath = Join-Path $PWD 'src/modules/npc_behavior'
          $projectIncludePath = Join-Path $PWD 'tools/scripts'
          $nwnxIncludePath = Join-Path $PWD 'third_party/nwnx_includes'
          $includeArgs = @('-i', $stockIncludePath, '-i', $sourceRootIncludePath, '-i', $npcBehaviorIncludePath, '-i', $projectIncludePath, '-i', $nwnxIncludePath)

          $logDir = Join-Path $PWD 'ci-logs'
          New-Item -ItemType Directory -Path $logDir -Force | Out-Null
          $logPath = Join-Path $logDir "$mode.log"
          if (Test-Path $logPath) { Remove-Item $logPath -Force }

          if ($mode -eq 'optimize') {
            if (Test-Path -Path 'output') {
              Remove-Item -Path 'output' -Recurse -Force
            }
            New-Item -ItemType Directory -Path 'output' -Force | Out-Null
          }

          $files = Get-ChildItem -Path 'src' -Recurse -File -Filter '*.nss' | Sort-Object FullName
          if ($files.Count -eq 0) {
            "No .nss files found under src/." | Tee-Object -FilePath $logPath -Append
            "MODE=$mode" | Tee-Object -FilePath $logPath -Append
            "SCRIPTS=0" | Tee-Object -FilePath $logPath -Append
            "WARNINGS=0" | Tee-Object -FilePath $logPath -Append
            "ERRORS=0" | Tee-Object -FilePath $logPath -Append
            exit 0
          }

          $warningCount = 0
          $errorCount = 0

          foreach ($file in $files) {
            "=== FILE: $($file.FullName) ===" | Tee-Object -FilePath $logPath -Append

            $commandArgs = @()
            switch ($mode) {
              'check' { $commandArgs = @($includeArgs + $file.FullName) }
              'bugscan' { $commandArgs = @($includeArgs + $file.FullName) }
              'optimize' { $commandArgs = @('-a', '-y', '-e') + $includeArgs + @('-o', 'output', $file.FullName) }
              default { throw "Unsupported mode: $mode" }
            }

            $output = & $compiler @commandArgs 2>&1
            $exitCode = $LASTEXITCODE

            foreach ($line in $output) {
              $text = [string]$line
              $text | Tee-Object -FilePath $logPath -Append
              if ($text -match '(?i)warning') { $warningCount++ }
              if ($text -match '(?i)error') { $errorCount++ }
            }

            if ($exitCode -ne 0) {
              $errorCount++
              "Compiler exited with non-zero code $exitCode for $($file.FullName)" | Tee-Object -FilePath $logPath -Append
            }
          }

          "" | Tee-Object -FilePath $logPath -Append
          "MODE=$mode" | Tee-Object -FilePath $logPath -Append
          "SCRIPTS=$($files.Count)" | Tee-Object -FilePath $logPath -Append
          "WARNINGS=$warningCount" | Tee-Object -FilePath $logPath -Append
          "ERRORS=$errorCount" | Tee-Object -FilePath $logPath -Append

          if ($errorCount -gt 0) {
            throw "Compilation finished with ERRORS=$errorCount"
          }

      - name: Upload logs (${{ matrix.mode }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ matrix.mode }}
          path: ci-logs/${{ matrix.mode }}.log

      - name: Upload compiled scripts (optimize)
        if: ${{ matrix.mode == 'optimize' && always() }}
        uses: actions/upload-artifact@v4
        with:
          name: compiled-ncs-${{ matrix.mode }}
          path: output/*.ncs
          if-no-files-found: warn

  compile-manual:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    runs-on: windows-latest
    name: compile (manual ${{ github.event.inputs.mode }})

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify runner OS and compiler binary
        shell: pwsh
        run: |
          if ($env:RUNNER_OS -ne 'Windows') {
            throw "This workflow requires windows-latest. Current RUNNER_OS: $env:RUNNER_OS"
          }

          if (-not (Test-Path -Path 'tools/NWNScriptCompiler.exe' -PathType Leaf)) {
            throw "NWNScriptCompiler.exe not found at tools/NWNScriptCompiler.exe."
          }

      - name: Prepare stock includes for CI
        shell: pwsh
        run: |
          $sourceStock = Join-Path $PWD 'third_party/nwn2_stock_scripts'
          $ciStock = Join-Path $PWD '.ci/nwn2_stock_scripts'

          if (Test-Path -Path $ciStock) {
            Remove-Item -Path $ciStock -Recurse -Force
          }

          New-Item -ItemType Directory -Path $ciStock -Force | Out-Null
          Copy-Item -Path (Join-Path $sourceStock '*') -Destination $ciStock -Recurse -Force

          $upperNwscript = Join-Path $ciStock 'nwscript.NSS'
          $lowerNwscript = Join-Path $ciStock 'nwscript.nss'

          if (-not (Test-Path -Path $upperNwscript -PathType Leaf)) {
            throw "Missing stock include file: $upperNwscript"
          }

          if (-not (Test-Path -Path $lowerNwscript -PathType Leaf)) {
            Copy-Item -Path $upperNwscript -Destination $lowerNwscript -Force
          }

      - name: Compile scripts (${{ github.event.inputs.mode }})
        shell: pwsh
        run: |
          $mode = '${{ github.event.inputs.mode }}'
          $compiler = Join-Path $PWD 'tools/NWNScriptCompiler.exe'
          $stockIncludePath = Join-Path $PWD '.ci/nwn2_stock_scripts'
          $sourceRootIncludePath = Join-Path $PWD 'src'
          $npcBehaviorIncludePath = Join-Path $PWD 'src/modules/npc_behavior'
          $projectIncludePath = Join-Path $PWD 'tools/scripts'
          $nwnxIncludePath = Join-Path $PWD 'third_party/nwnx_includes'
          $includeArgs = @('-i', $stockIncludePath, '-i', $sourceRootIncludePath, '-i', $npcBehaviorIncludePath, '-i', $projectIncludePath, '-i', $nwnxIncludePath)

          $logDir = Join-Path $PWD 'ci-logs'
          New-Item -ItemType Directory -Path $logDir -Force | Out-Null
          $logPath = Join-Path $logDir "$mode.log"
          if (Test-Path $logPath) { Remove-Item $logPath -Force }

          if ($mode -eq 'optimize' -or $mode -eq 'build') {
            if (Test-Path -Path 'output') {
              Remove-Item -Path 'output' -Recurse -Force
            }
            New-Item -ItemType Directory -Path 'output' -Force | Out-Null
          }

          $files = Get-ChildItem -Path 'src' -Recurse -File -Filter '*.nss' | Sort-Object FullName
          if ($files.Count -eq 0) {
            "No .nss files found under src/." | Tee-Object -FilePath $logPath -Append
            "MODE=$mode" | Tee-Object -FilePath $logPath -Append
            "SCRIPTS=0" | Tee-Object -FilePath $logPath -Append
            "WARNINGS=0" | Tee-Object -FilePath $logPath -Append
            "ERRORS=0" | Tee-Object -FilePath $logPath -Append
            exit 0
          }

          $warningCount = 0
          $errorCount = 0

          foreach ($file in $files) {
            "=== FILE: $($file.FullName) ===" | Tee-Object -FilePath $logPath -Append

            $commandArgs = @()
            switch ($mode) {
              'check' { $commandArgs = @($includeArgs + $file.FullName) }
              'bugscan' { $commandArgs = @($includeArgs + $file.FullName) }
              'build' { $commandArgs = $includeArgs + @('-o', 'output', $file.FullName) }
              'optimize' { $commandArgs = @('-a', '-y', '-e') + $includeArgs + @('-o', 'output', $file.FullName) }
              default { throw "Unsupported mode: $mode" }
            }

            $output = & $compiler @commandArgs 2>&1
            $exitCode = $LASTEXITCODE

            foreach ($line in $output) {
              $text = [string]$line
              $text | Tee-Object -FilePath $logPath -Append
              if ($text -match '(?i)warning') { $warningCount++ }
              if ($text -match '(?i)error') { $errorCount++ }
            }

            if ($exitCode -ne 0) {
              $errorCount++
              "Compiler exited with non-zero code $exitCode for $($file.FullName)" | Tee-Object -FilePath $logPath -Append
            }
          }

          "" | Tee-Object -FilePath $logPath -Append
          "MODE=$mode" | Tee-Object -FilePath $logPath -Append
          "SCRIPTS=$($files.Count)" | Tee-Object -FilePath $logPath -Append
          "WARNINGS=$warningCount" | Tee-Object -FilePath $logPath -Append
          "ERRORS=$errorCount" | Tee-Object -FilePath $logPath -Append

          if ($errorCount -gt 0) {
            throw "Compilation finished with ERRORS=$errorCount"
          }

      - name: Upload logs (${{ github.event.inputs.mode }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ github.event.inputs.mode }}
          path: ci-logs/${{ github.event.inputs.mode }}.log

      - name: Upload compiled scripts
        if: ${{ (github.event.inputs.mode == 'build' || github.event.inputs.mode == 'optimize') && always() }}
        uses: actions/upload-artifact@v4
        with:
          name: compiled-ncs-${{ github.event.inputs.mode }}
          path: output/*.ncs
          if-no-files-found: warn
