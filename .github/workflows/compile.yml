name: NWN Script Compiler

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Compilation mode"
        required: true
        type: choice
        options:
          - check
          - build
          - optimize
          - bugscan
        default: check

jobs:
  compile:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify runner OS and compiler binary
        shell: pwsh
        run: |
          if ($env:RUNNER_OS -ne 'Windows') {
            throw "This workflow requires windows-latest. Current RUNNER_OS: $env:RUNNER_OS"
          }

          if (-not (Test-Path -Path 'tools/NWNScriptCompiler.exe' -PathType Leaf)) {
            throw "NWNScriptCompiler.exe not found at tools/NWNScriptCompiler.exe."
          }

          $compiler = Join-Path $PWD 'tools/NWNScriptCompiler.exe'
          Write-Host "Runner OS: $env:RUNNER_OS"
          Write-Host "Compiler launch mode: direct executable invocation (& $compiler ...)"

      - name: Prepare stock includes for CI
        shell: pwsh
        run: |
          $sourceStock = Join-Path $PWD 'third_party/nwn2_stock_scripts'
          $ciStock = Join-Path $PWD '.ci/nwn2_stock_scripts'

          if (Test-Path -Path $ciStock) {
            Remove-Item -Path $ciStock -Recurse -Force
          }

          New-Item -ItemType Directory -Path $ciStock -Force | Out-Null
          Copy-Item -Path (Join-Path $sourceStock '*') -Destination $ciStock -Recurse -Force

          $upperNwscript = Join-Path $ciStock 'nwscript.NSS'
          $lowerNwscript = Join-Path $ciStock 'nwscript.nss'

          if (Test-Path -Path $upperNwscript -PathType Leaf) {
            if (-not (Test-Path -Path $lowerNwscript -PathType Leaf)) {
              Copy-Item -Path $upperNwscript -Destination $lowerNwscript -Force
            } else {
              Write-Host "Lowercase nwscript path already resolves in current filesystem: $lowerNwscript"
            }
          }

      - name: Log include diagnostics
        shell: pwsh
        run: |
          $ciStock = Join-Path $PWD '.ci/nwn2_stock_scripts'
          $compiler = Join-Path $PWD 'tools/NWNScriptCompiler.exe'
          $projectInclude = Join-Path $PWD 'tools/scripts'
          $nwnxInclude = Join-Path $PWD 'third_party/nwnx_includes'
          $sampleFile = Get-ChildItem -Path 'src' -Recurse -File -Filter '*.nss' | Sort-Object FullName | Select-Object -First 1

          $fileCount = (Get-ChildItem -Path $ciStock -Recurse -File | Measure-Object).Count
          Write-Host "Stock include file count: $fileCount"

          $lowerNwscript = Join-Path $ciStock 'nwscript.nss'
          if (Test-Path -Path $lowerNwscript -PathType Leaf) {
            Write-Host "Found lowercase nwscript: $lowerNwscript"
          } else {
            throw "Missing lowercase nwscript at $lowerNwscript"
          }

          if ($null -ne $sampleFile) {
            Write-Host "Diagnostic compile sample: $($sampleFile.FullName)"
            & $compiler -j -i $ciStock -i $projectInclude -i $nwnxInclude $sampleFile.FullName
          } else {
            Write-Host 'No .nss files found under src/; skipping diagnostic compile.'
          }

      - name: Compile scripts
        shell: pwsh
        run: |
          $mode = '${{ github.event.inputs.mode }}'
          $compiler = Join-Path $PWD 'tools/NWNScriptCompiler.exe'
          $stockIncludePath = Join-Path $PWD '.ci/nwn2_stock_scripts'
          $projectIncludePath = Join-Path $PWD 'tools/scripts'
          $nwnxIncludePath = Join-Path $PWD 'third_party/nwnx_includes'
          $includeArgs = @('-i', $stockIncludePath, '-i', $projectIncludePath, '-i', $nwnxIncludePath)
          $files = Get-ChildItem -Path 'src' -Recurse -File -Filter '*.nss' | Sort-Object FullName

          if ($files.Count -eq 0) {
            Write-Host 'No .nss files found under src/; nothing to compile.'
            exit 0
          }

          switch ($mode) {
            'optimize' {
              if (Test-Path -Path 'output') {
                Remove-Item -Path 'output' -Recurse -Force
              }
            }
            'build' {
              New-Item -ItemType Directory -Path 'output' -Force | Out-Null
            }
            'bugscan' {
              $issues = New-Object System.Collections.Generic.List[string]
              $errorCount = 0
              $warningCount = 0

              foreach ($file in $files) {
                Write-Host "Compiling $($file.FullName)"
                $output = & $compiler @includeArgs $file.FullName 2>&1
                $exitCode = $LASTEXITCODE

                foreach ($line in $output) {
                  Write-Host $line
                  if ($line -match '(?i)warning') {
                    $warningCount++
                    $issues.Add("[WARNING] $($file.FullName): $line")
                  }
                  if ($line -match '(?i)error') {
                    $errorCount++
                    $issues.Add("[ERROR] $($file.FullName): $line")
                  }
                }

                if ($exitCode -ne 0 -and -not ($output -match '(?i)error')) {
                  $errorCount++
                  $issues.Add("[ERROR] $($file.FullName): compiler exited with code $exitCode")
                }
              }

              Write-Host ''
              Write-Host '=== BUGSCAN SUMMARY ==='
              if ($issues.Count -eq 0) {
                Write-Host 'No warnings or errors found.'
                exit 0
              }

              foreach ($issue in $issues) {
                Write-Host $issue
              }

              Write-Host "Total warnings: $warningCount"
              Write-Host "Total errors: $errorCount"

              if ($errorCount -gt 0) {
                exit 1
              }

              exit 0
            }
            default {}
          }

          foreach ($file in $files) {
            Write-Host "Compiling $($file.FullName)"

            switch ($mode) {
              'check' {
                & $compiler @includeArgs $file.FullName
              }
              'build' {
                & $compiler @includeArgs -o output $file.FullName
              }
              'optimize' {
                & $compiler -a -y -e @includeArgs -o output $file.FullName
              }
              default {
                throw "Unsupported mode: $mode"
              }
            }

            if ($LASTEXITCODE -ne 0) {
              throw "Compilation failed for $($file.FullName)"
            }
          }

      - name: Upload compiled scripts
        if: ${{ github.event.inputs.mode == 'build' || github.event.inputs.mode == 'optimize' }}
        uses: actions/upload-artifact@v4
        with:
          name: compiled-ncs-${{ github.event.inputs.mode }}
          path: output
