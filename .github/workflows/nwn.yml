name: NWN Script Compiler

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Compilation mode"
        required: true
        type: choice
        options:
          - check
          - build
          - optimize
          - bugscan
        default: check

jobs:
  compile:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify compiler binary exists
        shell: pwsh
        run: |
          if (-not (Test-Path -Path 'tools/NWNScriptCompiler.exe' -PathType Leaf)) {
            throw "NWNScriptCompiler.exe not found at tools/NWNScriptCompiler.exe."
          }

      - name: Compile scripts
        shell: pwsh
        run: |
          $mode = '${{ github.event.inputs.mode }}'
          $compiler = Join-Path $PWD 'tools/NWNScriptCompiler.exe'
          $includePath = Join-Path $PWD 'third_party/nwn2_stock_scripts'
          $files = Get-ChildItem -Path 'src' -Recurse -File -Filter '*.nss' | Sort-Object FullName

          if ($files.Count -eq 0) {
            Write-Host 'No .nss files found under src/; nothing to compile.'
            exit 0
          }

          switch ($mode) {
            'optimize' {
              if (Test-Path -Path 'output') {
                Remove-Item -Path 'output' -Recurse -Force
              }
            }
            'build' {
              New-Item -ItemType Directory -Path 'output' -Force | Out-Null
            }
            'bugscan' {
              $issues = New-Object System.Collections.Generic.List[string]
              $errorCount = 0
              $warningCount = 0

              foreach ($file in $files) {
                Write-Host "Compiling $($file.FullName)"
                $output = & $compiler $file.FullName 2>&1
                $exitCode = $LASTEXITCODE

                foreach ($line in $output) {
                  Write-Host $line
                  if ($line -match '(?i)warning') {
                    $warningCount++
                    $issues.Add("[WARNING] $($file.FullName): $line")
                  }
                  if ($line -match '(?i)error') {
                    $errorCount++
                    $issues.Add("[ERROR] $($file.FullName): $line")
                  }
                }

                if ($exitCode -ne 0 -and -not ($output -match '(?i)error')) {
                  $errorCount++
                  $issues.Add("[ERROR] $($file.FullName): compiler exited with code $exitCode")
                }
              }

              Write-Host ''
              Write-Host '=== BUGSCAN SUMMARY ==='
              if ($issues.Count -eq 0) {
                Write-Host 'No warnings or errors found.'
                exit 0
              }

              foreach ($issue in $issues) {
                Write-Host $issue
              }

              Write-Host "Total warnings: $warningCount"
              Write-Host "Total errors: $errorCount"

              if ($errorCount -gt 0) {
                exit 1
              }

              exit 0
            }
            default {}
          }

          foreach ($file in $files) {
            Write-Host "Compiling $($file.FullName)"

            switch ($mode) {
              'check' {
                & $compiler $file.FullName
              }
              'build' {
                & $compiler -o output $file.FullName
              }
              'optimize' {
                & $compiler -a -y -e -i $includePath -o output $file.FullName
              }
              default {
                throw "Unsupported mode: $mode"
              }
            }

            if ($LASTEXITCODE -ne 0) {
              throw "Compilation failed for $($file.FullName)"
            }
          }

      - name: Upload compiled scripts
        if: ${{ github.event.inputs.mode == 'build' || github.event.inputs.mode == 'optimize' }}
        uses: actions/upload-artifact@v4
        with:
          name: compiled-ncs-${{ github.event.inputs.mode }}
          path: output
